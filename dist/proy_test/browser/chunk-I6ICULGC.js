import{a as R}from"./chunk-6WUTALT2.js";import{S as E,Wa as n,ca as d,d as f,eb as y,f as s,g as v,gb as l,h as C,ib as A,k as c,m as _,s as a,v as b,z as g}from"./chunk-7RPVYQIG.js";import{a as h,b as m}from"./chunk-6MDQTQU3.js";var I=class u{http=g(A);platformId=g(E);isBrowser=y(this.platformId);API_URL=`${R.apiUrl}/carrito`;STORAGE_KEY="tienda_carrito";get httpOptions(){return{headers:new l({"Content-Type":"application/json",Accept:"application/json"})}}_items=d([]);_cargando=d(!1);_error=d(null);_cuponAplicado=d(null);_sincronizado=d(!0);eventosCarrito$=new f(null);configuracion={maximo_items:50,maximo_cantidad_por_item:99,tiempo_sesion_minutos:120,auto_limpiar_items_sin_stock:!0,mostrar_productos_relacionados:!0,permitir_compra_sin_cuenta:!0,calcular_impuestos:!0,porcentaje_igv:18};items=this._items.asReadonly();cargando=this._cargando.asReadonly();error=this._error.asReadonly();cuponAplicado=this._cuponAplicado.asReadonly();sincronizado=this._sincronizado.asReadonly();itemsCount=n(()=>this._items().length);totalItems=n(()=>this._items().reduce((e,t)=>e+t.cantidad,0));subtotal=n(()=>this._items().reduce((e,t)=>e+t.subtotal,0));descuentos=n(()=>{let e=0;this._items().forEach(r=>{r.precio_oferta&&r.precio_oferta<r.precio&&(e+=(r.precio-r.precio_oferta)*r.cantidad)});let t=this._cuponAplicado();return t&&(t.tipo==="porcentaje"?e+=this.subtotal()*t.valor/100:t.tipo==="monto_fijo"&&(e+=t.valor)),e});impuestos=n(()=>this.configuracion.calcular_impuestos?(this.subtotal()-this.descuentos())*this.configuracion.porcentaje_igv/100:0);total=n(()=>this.subtotal()-this.descuentos()+this.impuestos());estaVacio=n(()=>this._items().length===0);resumen=n(()=>({items_count:this.itemsCount(),subtotal:this.subtotal(),descuentos:this.descuentos(),descuentos_aplicados:this.obtenerDescuentosAplicados(),impuestos:this.impuestos(),costo_envio:0,envio_gratis:!1,total:this.total(),peso_total:this.calcularPesoTotal()}));constructor(){this.isBrowser&&(this.cargarDesdeStorage(),setInterval(()=>{this._sincronizado()||this.guardarEnStorage()},5e3))}agregarItem(e){this._cargando.set(!0),this._error.set(null);let t=new l({"Content-Type":"application/json",Accept:"application/json","X-Session-ID":this.generateUniqueId()});return this.http.post(`${this.API_URL}/agregar`,e,{headers:t}).pipe(a(r=>{if(r.success&&r.data){this._items.set(r.data.items||[]),this._cuponAplicado.set(r.data.cupon_aplicado||null),this._sincronizado.set(!0),this.guardarEnStorage();let o=r.data.items?.find(i=>i.producto_id===e.producto_id&&i.variacion_id===e.variacion_id);o&&this.emitirEvento({tipo:"item_agregado",item:o,timestamp:new Date})}}),c(r=>(this._error.set("Error al agregar producto al carrito"),this.manejarErrorOffline(e))),a(()=>this._cargando.set(!1)))}actualizarCantidad(e,t){if(t<=0)return this.removerItem(e);t>this.configuracion.maximo_cantidad_por_item&&(t=this.configuracion.maximo_cantidad_por_item),this._cargando.set(!0);let r={item_id:e,cantidad:t};return this.http.put(`${this.API_URL}/actualizar`,r,this.httpOptions).pipe(a(o=>{o.success&&o.data&&(this._items.set(o.data.items||[]),this._cuponAplicado.set(o.data.cupon_aplicado||null),this._sincronizado.set(!0),this.guardarEnStorage())}),c(o=>(this._error.set("Error al actualizar cantidad"),this.actualizarCantidadOffline(e,t))),a(()=>this._cargando.set(!1)))}removerItem(e){return this._cargando.set(!0),this.http.delete(`${this.API_URL}/remover/${e}`,this.httpOptions).pipe(a(t=>{if(t.success&&t.data){let r=this._items().find(o=>o.id===e);this._items.set(t.data.items||[]),this._cuponAplicado.set(t.data.cupon_aplicado||null),this._sincronizado.set(!0),this.guardarEnStorage(),r&&this.emitirEvento({tipo:"item_removido",item:r,timestamp:new Date})}}),c(t=>(this._error.set("Error al remover producto"),this.removerItemOffline(e))),a(()=>this._cargando.set(!1)))}limpiarCarrito(){return this._cargando.set(!0),this.http.delete(`${this.API_URL}/limpiar`,this.httpOptions).pipe(a(e=>{e.success&&(this._items.set([]),this._cuponAplicado.set(null),this._sincronizado.set(!0),this.guardarEnStorage(),this.emitirEvento({tipo:"carrito_limpiado",timestamp:new Date}))}),c(e=>(this._error.set("Error al limpiar carrito"),v(()=>e))),a(()=>this._cargando.set(!1)))}aplicarCupon(e){return s({success:!0,message:`Cup\xF3n ${e.codigo} aplicado correctamente`,descuento:{tipo:"cupon",codigo:e.codigo,descripcion:`Descuento por cup\xF3n ${e.codigo}`,monto:25.5}}).pipe(_(1e3),a(t=>{if(t.success){let r={id:Date.now(),codigo:e.codigo,descripcion:`Descuento por cup\xF3n ${e.codigo}`,tipo:"porcentaje",valor:15,fecha_inicio:new Date,fecha_fin:new Date(Date.now()+2592e6),activo:!0};this._cuponAplicado.set(r),this.emitirEvento({tipo:"cupon_aplicado",cupon:e.codigo,timestamp:new Date}),this.guardarEnStorage()}}))}removerCupon(e){return s({success:!0,message:`Cup\xF3n ${e} eliminado correctamente`}).pipe(_(500),a(t=>{t.success&&(this._cuponAplicado.set(null),this.guardarEnStorage())}))}obtenerProductosRelacionados(){return this.http.get(`${this.API_URL}/productos-relacionados`,this.httpOptions).pipe(c(e=>(console.error("Error al cargar productos relacionados:",e),s([]))))}verificarDisponibilidad(){let e=this._items().map(t=>({producto_id:t.producto_id,variacion_id:t.variacion_id,cantidad:t.cantidad}));return this.http.post(`${this.API_URL}/verificar-stock`,{items:e},this.httpOptions).pipe(a(t=>{let r=t?.data||t;Array.isArray(r)?r.forEach(o=>{let i=this._items().find(p=>p.producto_id===o.producto_id&&p.variacion_id===o.variacion_id);i&&i.stock_disponible!==o.stock_disponible&&this.actualizarStockLocal(i.id,o.stock_disponible)}):console.warn("La respuesta de verificar-stock no es un array:",t)}),C(t=>{let r=t?.data||t;return Array.isArray(r)?r:[]}),c(t=>(console.error("Error al verificar disponibilidad:",t),s([]))))}cargarCarrito(){let e=new l({"Content-Type":"application/json",Accept:"application/json","X-Session-ID":this.generateUniqueId()});return this.http.get(`${this.API_URL}`,{headers:e}).pipe(a(t=>{console.log("Carrito cargado desde servidor:",t),t?.success&&t?.data&&(this._items.set(t.data.items||[]),this._cuponAplicado.set(t.data.cupon_aplicado||null),this._sincronizado.set(!0),this.guardarEnStorage())}),c(t=>(console.error("Error al cargar carrito:",t),this._error.set("Error al cargar el carrito"),s({success:!1,message:"Error al cargar carrito",data:{}}))))}generateUniqueId(){return"carrito_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}agregarItemLocal(e){let t=this._items(),r=t.find(o=>o.producto_id===e.producto_id&&o.variacion_id===e.variacion_id);if(r){let o=r.cantidad+e.cantidad;this.actualizarCantidadLocal(r.id,o)}else this._items.set([...t,e]);this._sincronizado.set(!1),this.guardarEnStorage()}actualizarCantidadLocal(e,t){let r=this._items(),o=r.findIndex(i=>i.id===e);if(o!==-1){let i=m(h({},r[o]),{cantidad:t,subtotal:t*(r[o].precio_oferta||r[o].precio),modificado_en:new Date}),p=[...r];p[o]=i,this._items.set(p),this.emitirEvento({tipo:"cantidad_actualizada",item:i,cantidad_anterior:r[o].cantidad,cantidad_nueva:t,timestamp:new Date})}this._sincronizado.set(!1),this.guardarEnStorage()}removerItemLocal(e){let t=this._items();this._items.set(t.filter(r=>r.id!==e)),this._sincronizado.set(!1),this.guardarEnStorage()}actualizarStockLocal(e,t){let r=this._items(),o=r.findIndex(i=>i.id===e);if(o!==-1){let i=[...r];i[o]=m(h({},i[o]),{stock_disponible:t}),this._items.set(i),this.guardarEnStorage()}}obtenerDescuentosAplicados(){let e=[];this._items().forEach(r=>{if(r.precio_oferta&&r.precio_oferta<r.precio){let o=(r.precio-r.precio_oferta)*r.cantidad;e.push({tipo:"promocion",descripcion:`Oferta en ${r.nombre}`,monto:o,porcentaje:(r.precio-r.precio_oferta)/r.precio*100})}});let t=this._cuponAplicado();if(t){let r=0;t.tipo==="porcentaje"?r=this.subtotal()*t.valor/100:t.tipo==="monto_fijo"&&(r=t.valor),e.push({tipo:"cupon",codigo:t.codigo,descripcion:t.descripcion,monto:r,porcentaje:t.tipo==="porcentaje"?t.valor:void 0})}return e}calcularPesoTotal(){return this._items().reduce((e,t)=>e+t.cantidad*.5,0)}cargarDesdeStorage(){try{let e=localStorage.getItem(this.STORAGE_KEY);if(e){let t=JSON.parse(e);this._items.set(t.items||[]),this._cuponAplicado.set(t.cupon_aplicado||null)}}catch(e){console.error("Error al cargar carrito desde localStorage:",e)}}guardarEnStorage(){if(this.isBrowser)try{let e={items:this._items(),resumen:this.resumen(),cupon_aplicado:this._cuponAplicado()||void 0,cargando:!1,guardado_en:new Date,sincronizado:this._sincronizado()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),this._sincronizado.set(!0)}catch(e){console.error("Error al guardar carrito en localStorage:",e)}}emitirEvento(e){this.eventosCarrito$.next(e)}manejarErrorOffline(e){return s({success:!1,message:"Sin conexi\xF3n. El producto se agregar\xE1 cuando se restablezca la conexi\xF3n.",data:{},errors:["offline"]})}actualizarCantidadOffline(e,t){return this.actualizarCantidadLocal(e,t),s({success:!0,message:"Cantidad actualizada localmente",data:{}})}removerItemOffline(e){return this.removerItemLocal(e),s({success:!0,message:"Producto removido localmente",data:{}})}get eventos$(){return this.eventosCarrito$.asObservable()}static \u0275fac=function(t){return new(t||u)};static \u0275prov=b({token:u,factory:u.\u0275fac,providedIn:"root"})};export{I as a};
