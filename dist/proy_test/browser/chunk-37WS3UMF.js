import{a as n}from"./chunk-6WUTALT2.js";import{b as l,ca as o,d as r,g as u,hb as g,ib as m,k as a,p as d,s as t,v as p,z as b}from"./chunk-7RPVYQIG.js";var f=class h{http=b(m);apiUrl=`${n.urlDominioApi}/api/cuenta-usuario`;dashboardSignal=o(null);loadingSignal=o(!1);errorSignal=o(null);estadisticasSignal=o(null);creditoSignal=o(null);dashboardSubject=new r(null);loadingSubject=new r(!1);errorSubject=new r(null);estadisticasSubject=new r(null);notificacionesNoLeidasSubject=new r(0);dashboard$=this.dashboardSubject.asObservable();loading$=this.loadingSubject.asObservable();error$=this.errorSubject.asObservable();estadisticas$=this.estadisticasSubject.asObservable();notificacionesNoLeidas$=this.notificacionesNoLeidasSubject.asObservable();dashboardData=this.dashboardSignal.asReadonly();isLoading=this.loadingSignal.asReadonly();errorMessage=this.errorSignal.asReadonly();estadisticasData=this.estadisticasSignal.asReadonly();creditoData=this.creditoSignal.asReadonly();cacheConfig={dashboard:{ttl:5*60*1e3,data:null,timestamp:0},credito:{ttl:10*60*1e3,data:null,timestamp:0},direcciones:{ttl:15*60*1e3,data:null,timestamp:0}};getDashboard(e=!1){return!e&&this.isCacheValid("dashboard")?new l(s=>{s.next(this.cacheConfig.dashboard.data),s.complete()}):(this.setLoading(!0),this.clearError(),this.http.get(`${this.apiUrl}/dashboard`).pipe(t(s=>{s.status==="success"&&(this.updateDashboardState(s.data),this.updateCache("dashboard",s)),this.setLoading(!1)}),a(s=>(this.setLoading(!1),this.handleError(s))),d(1)))}getPedidos(e){let s=this.buildHttpParams(e);return this.http.get(`${this.apiUrl}/pedidos`,{params:s}).pipe(a(this.handleError))}getPedidoDetalle(e){return this.setLoading(!0),this.http.get(`${this.apiUrl}/pedidos/${e}`).pipe(t(()=>this.setLoading(!1)),a(s=>(this.setLoading(!1),this.handleError(s))))}getFavoritos(e){let s=this.buildHttpParams(e);return this.http.get(`${this.apiUrl}/favoritos`,{params:s}).pipe(a(this.handleError))}getCategoriasFavoritos(){return this.http.get(`${this.apiUrl}/favoritos/categorias`).pipe(a(this.handleError))}toggleFavorito(e){return this.http.post(`${this.apiUrl}/favoritos/toggle`,{producto_id:e}).pipe(a(this.handleError))}getDepartamentos(){return this.http.get(`${n.urlDominioApi}/api/ubicacion/departamentos`).pipe(a(this.handleError))}getProvincias(e){return this.http.get(`${n.urlDominioApi}/api/ubicacion/provincias/departamento/${e}`).pipe(a(this.handleError))}getDistritos(e){return this.http.get(`${n.urlDominioApi}/api/ubicacion/distritos/provincia/${e}`).pipe(a(this.handleError))}crearDireccion(e){return this.http.post(`${this.apiUrl}/direcciones`,e).pipe(a(this.handleError))}actualizarDireccion(e,s){return this.http.put(`${this.apiUrl}/direcciones/${e}`,s).pipe(a(this.handleError))}establecerDireccionPredeterminada(e){return this.http.put(`${this.apiUrl}/direcciones/${e}/predeterminada`,{}).pipe(a(this.handleError))}eliminarDireccion(e){return this.http.delete(`${this.apiUrl}/direcciones/${e}`).pipe(a(this.handleError))}getDirecciones(e=!1){return!e&&this.isCacheValid("direcciones")?new l(s=>{s.next(this.cacheConfig.direcciones.data),s.complete()}):(this.setLoading(!0),this.http.get(`${this.apiUrl}/direcciones`).pipe(t(s=>{s.status==="success"&&this.updateCache("direcciones",s),this.setLoading(!1)}),a(s=>(this.setLoading(!1),this.handleError(s))),d(1)))}getHistorial(e){this.setLoading(!0);let s=this.buildHttpParams(e);return this.http.get(`${this.apiUrl}/historial`,{params:s}).pipe(t(()=>this.setLoading(!1)),a(i=>(this.setLoading(!1),this.handleError(i))))}getNotificaciones(e){this.setLoading(!0);let s=this.buildHttpParams(e);return this.http.get(`${this.apiUrl}/notificaciones`,{params:s}).pipe(t(i=>{i.status==="success"&&this.notificacionesNoLeidasSubject.next(i.data.no_leidas),this.setLoading(!1)}),a(i=>(this.setLoading(!1),this.handleError(i))))}marcarNotificacionLeida(e){return this.http.put(`${this.apiUrl}/notificaciones/${e}/marcar-leida`,{}).pipe(t(s=>{if(s.success){let i=this.notificacionesNoLeidasSubject.value;this.notificacionesNoLeidasSubject.next(Math.max(0,i-1)),this.invalidateCache("dashboard")}}),a(this.handleError))}marcarTodasNotificacionesLeidas(){return this.http.put(`${this.apiUrl}/notificaciones/marcar-todas-leidas`,{}).pipe(t(e=>{e.success&&(this.notificacionesNoLeidasSubject.next(0),this.invalidateCache("dashboard"))}),a(this.handleError))}getInformacionCredito(e=!1){return!e&&this.isCacheValid("credito")?new l(s=>{s.next(this.cacheConfig.credito.data),s.complete()}):(this.setLoading(!0),this.http.get(`${this.apiUrl}/credito`).pipe(t(s=>{s.status==="success"&&(this.creditoSignal.set(s.data),this.updateCache("credito",s)),this.setLoading(!1)}),a(s=>(this.setLoading(!1),this.handleError(s))),d(1)))}refreshAllData(){return this.clearAllCache(),this.getDashboard(!0).pipe(t(()=>{this.getInformacionCredito(!0).subscribe(),this.getDirecciones(!0).subscribe()}))}invalidateCache(e){this.cacheConfig[e]&&(this.cacheConfig[e].timestamp=0,this.cacheConfig[e].data=null)}clearAllCache(){Object.keys(this.cacheConfig).forEach(e=>{this.invalidateCache(e)})}getNotificacionesNoLeidasCount(){return this.notificacionesNoLeidas$}getEstadisticas(){return this.estadisticas$}getCurrentDashboard(){return this.dashboardSignal()||this.dashboardSubject.value}getCurrentCredito(){return this.creditoSignal()}getPerfilUsuario(){return this.http.get(`${this.apiUrl}/perfil`).pipe(a(this.handleError))}actualizarPerfil(e){return this.http.put(`${this.apiUrl}/perfil`,e).pipe(a(this.handleError))}cambiarPassword(e){return this.http.put(`${this.apiUrl}/cambiar-password`,e).pipe(a(this.handleError))}buildHttpParams(e){let s=new g;return e&&Object.entries(e).forEach(([i,c])=>{c!=null&&c!==""&&(s=s.set(i,c.toString()))}),s}isCacheValid(e){let s=this.cacheConfig[e];return!s.data||!s.timestamp?!1:Date.now()-s.timestamp<s.ttl}updateCache(e,s){this.cacheConfig[e].data=s,this.cacheConfig[e].timestamp=Date.now()}updateDashboardState(e){this.dashboardSignal.set(e),this.dashboardSubject.next(e),this.estadisticasSignal.set(e.estadisticas),this.estadisticasSubject.next(e.estadisticas),this.notificacionesNoLeidasSubject.next(e.estadisticas.notificaciones_no_leidas)}setLoading(e){this.loadingSignal.set(e),this.loadingSubject.next(e)}clearError(){this.errorSignal.set(null),this.errorSubject.next(null)}handleError=e=>{console.error("\u274C Error en CuentaUsuarioService:",e);let s="Ha ocurrido un error inesperado";switch(e.error?.message?s=e.error.message:e.message?s=e.message:typeof e=="string"&&(s=e),e.status){case 401:s="Tu sesi\xF3n ha expirado. Por favor, inicia sesi\xF3n nuevamente.";break;case 403:s="No tienes permisos para acceder a esta informaci\xF3n.";break;case 404:s="La informaci\xF3n solicitada no fue encontrada.";break;case 422:s="Los datos enviados no son v\xE1lidos.";break;case 429:s="Demasiadas solicitudes. Por favor, intenta m\xE1s tarde.";break;case 500:s="Error interno del servidor. Por favor, intenta m\xE1s tarde.";break}return this.errorSignal.set(s),this.errorSubject.next(s),u(()=>new Error(s))};ngOnDestroy(){this.dashboardSubject.complete(),this.loadingSubject.complete(),this.errorSubject.complete(),this.estadisticasSubject.complete(),this.notificacionesNoLeidasSubject.complete(),this.clearAllCache()}static \u0275fac=function(s){return new(s||h)};static \u0275prov=p({token:h,factory:h.\u0275fac,providedIn:"root"})};export{f as a};
