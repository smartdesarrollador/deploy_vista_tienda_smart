import{a as g}from"./chunk-IYW2DV6Z.js";import{E as y,M as R,Wa as s,b as f,ca as P,d as v,g as m,h as c,hb as p,ib as w,k as i,o as a,r as S,s as n,v as E,z as h}from"./chunk-7RPVYQIG.js";import{a as u,b}from"./chunk-6MDQTQU3.js";function O(d){d||(y(O),d=h(R));let e=new f(t=>d.onDestroy(t.next.bind(t)));return t=>t.pipe(S(e))}var L=class d{http=h(w);baseUrl=g.apiUrl;baseUrlImagenes=g.urlDominioApi+"/";_state=P({productos:[],currentProducto:null,loading:!1,error:null,filters:{},pagination:null,statistics:null});productos=s(()=>this._state().productos);currentProducto=s(()=>this._state().currentProducto);loading=s(()=>this._state().loading);error=s(()=>this._state().error);filters=s(()=>this._state().filters);pagination=s(()=>this._state().pagination);statistics=s(()=>this._state().statistics);hasProductos=s(()=>this.productos().length>0);totalProductos=s(()=>this.pagination()?.total??0);currentPage=s(()=>this.pagination()?.current_page??1);lastPage=s(()=>this.pagination()?.last_page??1);hasNextPage=s(()=>this.currentPage()<this.lastPage());hasPrevPage=s(()=>this.currentPage()>1);refreshSubject=new v(void 0);constructor(){}getProductos(e={}){this.setLoading(!0),this.setError(null);let t=new p;e.per_page||(t=t.set("per_page","100")),Object.entries(e).forEach(([o,l])=>{l!=null&&l!==""&&(t=t.set(o,l.toString()))});let r=`${this.baseUrl}/productos`;return console.log("ProductoService: Haciendo petici\xF3n a:",r),console.log("ProductoService: Base URL:",this.baseUrl),console.log("ProductoService: Environment API URL:",g.apiUrl),console.log("ProductoService: Par\xE1metros:",t.toString()),this.http.get(r,{params:t}).pipe(n(o=>{console.log("ProductoService: Respuesta recibida:",o),console.log("ProductoService: Total de productos:",o.data.length),this.updateState({productos:o.data,pagination:o.meta,filters:e})}),i(o=>(console.error("ProductoService: Error en petici\xF3n:",o),this.handleError(o))),a(()=>this.setLoading(!1)))}getProducto(e){return this.setLoading(!0),this.setError(null),this.http.get(`${this.baseUrl}/productos/${e}`).pipe(n(t=>{this.updateState({currentProducto:t.data})}),i(t=>this.handleError(t)),a(()=>this.setLoading(!1)))}createProducto(e){this.setLoading(!0),this.setError(null);let t=this.buildFormData(e);return this.http.post(`${this.baseUrl}/vista/productos`,t).pipe(n(r=>{this.updateState({currentProducto:r.data})}),i(r=>this.handleError(r)),a(()=>this.setLoading(!1)))}updateProducto(e,t){this.setLoading(!0),this.setError(null);let r=this.buildFormData(t);return this.http.post(`${this.baseUrl}/vista/productos/${e}`,r).pipe(n(o=>{this.updateState({currentProducto:o.data})}),i(o=>this.handleError(o)),a(()=>this.setLoading(!1)))}deleteProducto(e){return this.setLoading(!0),this.setError(null),this.http.delete(`${this.baseUrl}/vista/productos/${e}`).pipe(n(()=>{this.updateState({currentProducto:null})}),i(t=>this.handleError(t)),a(()=>this.setLoading(!1)))}getProductosByCategoria(e){return this.setLoading(!0),this.setError(null),this.http.get(`${this.baseUrl}/productos/categoria/${e}`).pipe(c(t=>t.data),i(t=>this.handleError(t)),a(()=>this.setLoading(!1)))}getProductosDestacados(e=10){this.setLoading(!0),this.setError(null);let t=new p().set("limit",e.toString());return this.http.get(`${this.baseUrl}/productos/destacados`,{params:t}).pipe(c(r=>r.data),i(r=>this.handleError(r)),a(()=>this.setLoading(!1)))}searchProductos(e){this.setLoading(!0),this.setError(null);let t=new p().set("q",e.q);return e.limit&&(t=t.set("limit",e.limit.toString())),this.http.get(`${this.baseUrl}/productos/search`,{params:t}).pipe(c(r=>r.data),i(r=>this.handleError(r)),a(()=>this.setLoading(!1)))}toggleDestacado(e){return this.setLoading(!0),this.setError(null),this.http.post(`${this.baseUrl}/vista/productos/${e}/toggle-destacado`,{}).pipe(n(t=>{this.updateState({currentProducto:t.data})}),i(t=>this.handleError(t)),a(()=>this.setLoading(!1)))}toggleActivo(e){return this.setLoading(!0),this.setError(null),this.http.post(`${this.baseUrl}/vista/productos/${e}/toggle-activo`,{}).pipe(n(t=>{this.updateState({currentProducto:t.data})}),i(t=>this.handleError(t)),a(()=>this.setLoading(!1)))}removeImagenPrincipal(e){return this.setLoading(!0),this.setError(null),this.http.delete(`${this.baseUrl}/vista/productos/${e}/imagen-principal`).pipe(n(t=>{this.updateState({currentProducto:t.data})}),i(t=>this.handleError(t)),a(()=>this.setLoading(!1)))}getStatistics(){this.setLoading(!0),this.setError(null);let e=`${this.baseUrl}/vista/productos/statistics`;return console.log("ProductoService: Obteniendo estad\xEDsticas desde:",e),this.http.get(e).pipe(c(t=>t.data),n(t=>{console.log("ProductoService: Estad\xEDsticas recibidas:",t),this.updateState({statistics:t})}),i(t=>(console.error("ProductoService: Error al obtener estad\xEDsticas:",t),this.handleError(t))),a(()=>this.setLoading(!1)))}loadProductos(e){let t=e||this.filters();this.getProductos(t).subscribe({next:()=>{},error:r=>{console.error("Error al cargar productos:",r)}})}refresh(){this.refreshSubject.next()}refreshProductos(){this.loadProductos()}clearState(){this._state.set({productos:[],currentProducto:null,loading:!1,error:null,filters:{},pagination:null,statistics:null})}setFilters(e){this.updateState({filters:e})}clearFilters(){this.updateState({filters:{}})}goToPage(e){let t=b(u({},this.filters()),{page:e});this.loadProductos(t)}nextPage(){this.hasNextPage()&&this.goToPage(this.currentPage()+1)}prevPage(){this.hasPrevPage()&&this.goToPage(this.currentPage()-1)}changePageSize(e){let t=b(u({},this.filters()),{per_page:e,page:1});this.loadProductos(t)}updateState(e){this._state.update(t=>u(u({},t),e))}setLoading(e){this.updateState({loading:e})}setError(e){this.updateState({error:e})}buildFormData(e){let t=new FormData;return Object.entries(e).forEach(([r,o])=>{o!=null&&(r==="imagen_principal"&&o instanceof File?t.append(r,o):r==="atributos_extra"&&typeof o=="object"?t.append(r,JSON.stringify(o)):t.append(r,o.toString()))}),"id"in e&&t.append("_method","PUT"),t}handleError(e){let t="Ha ocurrido un error inesperado";if(e.error instanceof ErrorEvent)t=`Error: ${e.error.message}`;else{let r=e.error;r?.message?t=r.message:e.status===0?t="No se puede conectar con el servidor":t=`Error ${e.status}: ${e.statusText}`}return this.setError(t),console.error("ProductoService Error:",e),m(()=>new Error(t))}static \u0275fac=function(t){return new(t||d)};static \u0275prov=E({token:d,factory:d.\u0275fac,providedIn:"root"})};export{O as a,L as b};
